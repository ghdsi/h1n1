#!/usr/bin/python3

import csv
import glob
import os
import sys

# from tools import data_util, generate_full_data

CSV_FILE = "HealthMap_H1N1_Global_All_Languages_2009-2012.csv"
LAT_LNG_DECIMAL_PLACES = 4
SELF_DIR = os.path.dirname(os.path.realpath(__file__))

FIELDS = {
    "location": 0,
    "country": 1,
    "disease": 2,
    "species": 3,
    "language": 4,
    "alert-id": 5,
    "article-title": 6,
    "source-url": 7,
    "datetime": 8,
    "alert-tag": 9,
    "suspected-cases": 10,   # Can be ignored for now
    "suspected-deaths": 11,  # Can be ignored for now
    "confirmed-cases": 12,
    "confirmed-deaths": 13,
    "ruled-out": 14,         # Rarely used for this disease
    "longitude": 15,
    "latitude": 16,
}

def check_for_common_repo():
    if not os.path.exists("../common"):
        print("Please clone the 'common' repo as a sibling of this one:")
        print("cd .. && git clone git@github.com:globaldothealth/common.git")
        return False
    return True

def clean():
    for daily in glob.glob("d/*.json"):
        os.remove(daily)
    for country in glob.glob("c/*.json"):
        os.remove(country)

def round_latlng(l):
    if "." not in l:
        l += ".0000"
    (intpart, dec) = l.split(".")
    if len(dec) > LAT_LNG_DECIMAL_PLACES:
        # Just truncate
        dec = dec[0:4]
    elif len(dec) < LAT_LNG_DECIMAL_PLACES:
        dec += "0" * (LAT_LNG_DECIMAL_PLACES - len(dec))
    return intpart + "." + dec

def make_geoid(lat, lng):
    return round_latlng(lat) + "|" + round_latlng(lng)

def process_single_row(r):
    geoid = make_geoid(r[FIELDS["latitude"]], r[FIELDS["longitude"]])
    print(geoid)
    country_code = country_converter.code_from_name(r[FIELDS["country"]])
    return None

def process_csv_file(csv_file_path):
    with open(csv_file_path) as f:
        reader = csv.reader(f)
        for row in reader:
            process_single_row(row)

def update():
    # generate_full_data.generate_data(
        # os.path.join(SELF_DIR, "d"),
        # os.path.join(SELF_DIR, "c"),
        # overwrite=True, quiet=False)
    # data_util.retrieve_generable_data(".", should_overwrite=True, quiet=False)
    # Note sure why there are two lines merged together for a couple of locations
    # os.system("./sanitize_location_info")
    process_csv_file(CSV_FILE)
    # Add any new daily file.
    os.system("git add d/*.json")

if __name__ == "__main__":
    if check_for_common_repo():
        sys.path.insert(0, "../common/tools")
        import country_converter
        clean()
        update()
